<div id="physics-quiz-container" style="min-height: 750px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; align-items: center; justify-content: center; padding: 20px;">
    <div id="start-screen" class="quiz-box">
        <h1 style="color: #fff; margin-bottom: 10px;">GCSE Equation Master</h1>
        <p style="color: #eee; margin-bottom: 25px;">15 Questions • 4 Attempts • Real-time Feedback</p>
        <button onclick="quiz.start()" class="primary-btn">Start Game</button>
    </div>

    <div id="quiz-ui" class="quiz-box" style="display:none; width: 100%; max-width: 600px;">
        <div class="header-stats">
            <div class="stat-pill">Time: <span id="timer">00:00</span></div>
            <div class="stat-pill">Progress: <span id="progress">0/15</span></div>
            <div class="stat-pill">Score: <span id="score">0</span></div>
        </div>
        
        <div class="question-container">
            <p id="question-text"></p>
        </div>

        <div class="interaction-container">
            <div class="input-row">
                <input type="number" id="user-answer" placeholder="Enter value..." step="any">
                <select id="user-unit"></select>
                <button onclick="quiz.checkAnswer()" id="submit-btn" class="check-btn">Check</button>
            </div>
            <div id="feedback-row">
                <p id="feedback"></p>
            </div>
        </div>

        <div class="hints-container">
            <div id="hint-1" class="hint-box"></div>
            <div id="hint-2" class="hint-box"></div>
            <div id="hint-3" class="hint-box reveal-box"></div>
            <div id="attempts-left">Attempts remaining: 4</div>
        </div>

        <div class="action-footer">
            <button onclick="quiz.skipQuestion()" class="skip-btn">Skip Question</button>
        </div>
    </div>

    <div id="result-screen" class="quiz-box" style="display:none;">
        <h2 style="color: #fff;">Results</h2>
        <div id="final-stats" style="font-size: 1.8rem; margin: 20px 0; font-weight: bold;"></div>
        <div id="review-list"></div>
        <button onclick="location.reload()" class="primary-btn" style="margin-top: 25px;">Restart Challenge</button>
    </div>
</div>

<style>
    .quiz-box {
        background: linear-gradient(145deg, #2e3192 0%, #1bffff 100%);
        border-radius: 28px;
        padding: 40px;
        color: white;
        text-align: center;
        box-shadow: 0 15px 35px rgba(0,0,0,0.3);
        border: 1px solid rgba(255,255,255,0.2);
    }
    .header-stats { display: flex; justify-content: space-around; margin-bottom: 20px; }
    .stat-pill { background: rgba(0,0,0,0.3); padding: 5px 15px; border-radius: 15px; font-family: monospace; font-size: 1rem; }
    .question-container { height: 130px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; line-height: 1.5; margin-bottom: 10px; }
    .interaction-container { height: 120px; }
    .input-row { display: flex; gap: 10px; justify-content: center; }
    .input-row input, .input-row select { padding: 12px; border-radius: 12px; border: none; font-size: 1rem; outline: none; }
    .input-row input { width: 140px; }
    .check-btn { background: #ffcf00; color: #333; border: none; padding: 12px 25px; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; }
    .check-btn:hover { background: #fff; transform: scale(1.05); }
    #feedback-row { height: 30px; margin-top: 10px; font-weight: bold; }
    .hints-container { height: 210px; background: rgba(255,255,255,0.1); border-radius: 20px; padding: 15px; text-align: left; }
    .hint-box { min-height: 35px; margin-bottom: 8px; font-size: 0.95rem; color: #fff; }
    .reveal-box { color: #ffeb3b; font-weight: bold; }
    #attempts-left { text-align: center; font-size: 0.8rem; opacity: 0.8; margin-top: 10px; }
    .primary-btn { background: #ffffff; color: #2e3192; border: none; padding: 15px 40px; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 1.1rem; }
    .skip-btn { background: transparent; border: 1px solid rgba(255,255,255,0.5); color: white; padding: 8px 20px; border-radius: 10px; cursor: pointer; font-size: 0.8rem; }
    #review-list { text-align: left; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 15px; max-height: 150px; overflow-y: auto; }
</style>

<script>
const equations = [

    {
        name: "Kinetic Energy",
        vars: { Ek: "kinetic energy", m: "mass", v: "speed" },
        units: { Ek: "J", m: "kg", v: "m/s" },
        formula: (v) => 0.5 * v.m * Math.pow(v.v, 2),
        solveFor: {
            Ek: { calc: (v) => 0.5 * v.m * Math.pow(v.v, 2), sym: "E<sub>k</sub> = 0.5 &times; m &times; v&sup2;" },
            m: { calc: (v) => (2 * v.Ek) / Math.pow(v.v, 2), sym: "m = (2 &times; E<sub>k</sub>) / v&sup2;" },
            v: { calc: (v) => Math.sqrt((2 * v.Ek) / v.m), sym: "v = &radic;(2 &times; E<sub>k</sub> / m)" }
        },
        ranges: { Ek: [1, 5000], m: [0.1, 100], v: [1, 40] },
        symbolic: "E<sub>k</sub> = 0.5 m v&sup2;" // [cite: 5, 11]
    },
    {
        name: "Elastic Potential Energy",
        vars: { Ee: "elastic potential energy", k: "spring constant", e: "extension" },
        units: { Ee: "J", k: "N/m", e: "m" },
        formula: (v) => 0.5 * v.k * Math.pow(v.e, 2),
        solveFor: {
            Ee: { calc: (v) => 0.5 * v.k * Math.pow(v.e, 2), sym: "E<sub>e</sub> = 0.5 &times; k &times; e&sup2;" },
            k: { calc: (v) => (2 * v.Ee) / Math.pow(v.e, 2), sym: "k = (2 &times; E<sub>e</sub>) / e&sup2;" },
            e: { calc: (v) => Math.sqrt((2 * v.Ee) / v.k), sym: "e = &radic;(2 &times; E<sub>e</sub> / k)" }
        },
        ranges: { Ee: [0.1, 200], k: [1, 100], e: [0.01, 2] },
        symbolic: "E<sub>e</sub> = 0.5 k e&sup2;" // [cite: 6, 11]
    },
    {
        name: "Gravitational Potential Energy",
        vars: { Ep: "gravitational potential energy", m: "mass", g: "gravitational field strength", h: "height" },
        units: { Ep: "J", m: "kg", g: "N/kg", h: "m" },
        formula: (v) => v.m * v.g * v.h,
        solveFor: {
            Ep: { calc: (v) => v.m * v.g * v.h, sym: "E<sub>p</sub> = m &times; g &times; h" },
            m: { calc: (v) => v.Ep / (v.g * v.h), sym: "m = E<sub>p</sub> / (g &times; h)" },
            g: { calc: (v) => v.Ep / (v.m * v.h), sym: "g = E<sub>p</sub> / (m &times; h)" },
            h: { calc: (v) => v.Ep / (v.m * v.g), sym: "h = E<sub>p</sub> / (m &times; g)" }
        },
        ranges: { Ep: [1, 5000], m: [0.1, 100], g: [9.8, 10], h: [1, 50] },
        symbolic: "E<sub>p</sub> = m g h" // [cite: 7, 12]
    },
    {
        name: "Power (Energy Transfer)",
        vars: { P: "power", E: "energy transferred", t: "time" },
        units: { P: "W", E: "J", t: "s" },
        formula: (v) => v.E / v.t,
        solveFor: {
            P: { calc: (v) => v.E / v.t, sym: "P = E / t" },
            E: { calc: (v) => v.P * v.t, sym: "E = P &times; t" },
            t: { calc: (v) => v.E / v.P, sym: "t = E / P" }
        },
        ranges: { P: [1, 3000], E: [100, 10000], t: [1, 600] },
        symbolic: "P = E / t" // [cite: 9, 14]
    },

    // --- ELECTRICITY ---
    {
        name: "Charge Flow",
        vars: { Q: "charge flow", I: "current", t: "time" },
        units: { Q: "C", I: "A", t: "s" },
        formula: (v) => v.I * v.t,
        solveFor: {
            Q: { calc: (v) => v.I * v.t, sym: "Q = I &times; t" },
            I: { calc: (v) => v.Q / v.t, sym: "I = Q / t" },
            t: { calc: (v) => v.Q / v.I, sym: "t = Q / I" }
        },
        ranges: { Q: [1, 100], I: [0.1, 10], t: [1, 120] },
        symbolic: "Q = I t" // [cite: 21, 22]
    },
    {
        name: "Potential Difference",
        vars: { V: "potential difference", I: "current", R: "resistance" },
        units: { V: "V", I: "A", R: "&Omega;" },
        formula: (v) => v.I * v.R,
        solveFor: {
            V: { calc: (v) => v.I * v.R, sym: "V = I &times; R" },
            I: { calc: (v) => v.V / v.R, sym: "I = V / R" },
            R: { calc: (v) => v.V / v.I, sym: "R = V / I" }
        },
        ranges: { V: [1, 230], I: [0.1, 13], R: [1, 1000] },
        symbolic: "V = I R" // [cite: 23, 24]
    },
    {
        name: "Electrical Power",
        vars: { P: "power", V: "potential difference", I: "current" },
        units: { P: "W", V: "V", I: "A" },
        formula: (v) => v.V * v.I,
        solveFor: {
            P: { calc: (v) => v.V * v.I, sym: "P = V &times; I" },
            V: { calc: (v) => v.P / v.I, sym: "V = P / I" },
            I: { calc: (v) => v.P / v.V, sym: "I = P / V" }
        },
        ranges: { P: [1, 3000], V: [1, 230], I: [0.1, 13] },
        symbolic: "P = V I" // [cite: 25, 26]
    },

    // --- PARTICLE MODEL OF MATTER ---
    {
        name: "Density",
        vars: { rho: "density", m: "mass", V: "volume" },
        units: { rho: "kg/m&sup3;", m: "kg", V: "m&sup3;" },
        formula: (v) => v.m / v.V,
        solveFor: {
            rho: { calc: (v) => v.m / v.V, sym: "&rho; = m / V" },
            m: { calc: (v) => v.rho * v.V, sym: "m = &rho; &times; V" },
            V: { calc: (v) => v.m / v.rho, sym: "V = m / &rho;" }
        },
        ranges: { rho: [500, 10000], m: [0.1, 50], V: [0.001, 1] },
        symbolic: "&rho; = m / V" // [cite: 32, 34]
    },

    // --- FORCES ---
    {
        name: "Weight",
        vars: { W: "weight", m: "mass", g: "gravitational field strength" },
        units: { W: "N", m: "kg", g: "N/kg" },
        formula: (v) => v.m * v.g,
        solveFor: {
            W: { calc: (v) => v.m * v.g, sym: "W = m &times; g" },
            m: { calc: (v) => v.W / v.g, sym: "m = W / g" },
            g: { calc: (v) => v.W / v.m, sym: "g = W / m" }
        },
        ranges: { W: [1, 1000], m: [0.1, 100], g: [1.6, 25] },
        symbolic: "W = m g" // 
    },
    {
        name: "Work Done",
        vars: { W: "work done", F: "force", s: "distance" },
        units: { W: "J", F: "N", s: "m" },
        formula: (v) => v.F * v.s,
        solveFor: {
            W: { calc: (v) => v.F * v.s, sym: "W = F &times; s" },
            F: { calc: (v) => v.W / v.s, sym: "F = W / s" },
            s: { calc: (v) => v.W / v.F, sym: "s = W / F" }
        },
        ranges: { W: [1, 5000], F: [1, 500], s: [1, 100] },
        symbolic: "W = F s" // 
    },
    {
        name: "Moment of a Force",
        vars: { M: "moment of a force", F: "force", d: "distance" },
        units: { M: "Nm", F: "N", d: "m" },
        formula: (v) => v.F * v.d,
        solveFor: {
            M: { calc: (v) => v.F * v.d, sym: "M = F &times; d" },
            F: { calc: (v) => v.M / v.d, sym: "F = M / d" },
            d: { calc: (v) => v.M / v.F, sym: "d = M / F" }
        },
        ranges: { M: [1, 500], F: [1, 100], d: [0.1, 10] },
        symbolic: "M = F d" // 
    },
    {
        name: "Resultant Force",
        vars: { F: "resultant force", m: "mass", a: "acceleration" },
        units: { F: "N", m: "kg", a: "m/s&sup2;" },
        formula: (v) => v.m * v.a,
        solveFor: {
            F: { calc: (v) => v.m * v.a, sym: "F = m &times; a" },
            m: { calc: (v) => v.F / v.a, sym: "m = F / a" },
            a: { calc: (v) => v.F / v.m, sym: "a = F / m" }
        },
        ranges: { F: [1, 1000], m: [0.1, 100], a: [0.1, 20] },
        symbolic: "F = m a" // 
    },
    {
        name: "Momentum (HT)",
        vars: { p: "momentum", m: "mass", v: "velocity" },
        units: { p: "kg m/s", m: "kg", v: "m/s" },
        formula: (v) => v.m * v.v,
        solveFor: {
            p: { calc: (v) => v.m * v.v, sym: "p = m &times; v" },
            m: { calc: (v) => v.p / v.v, sym: "m = p / v" },
            v: { calc: (v) => v.p / v.m, sym: "v = p / m" }
        },
        ranges: { p: [1, 1000], m: [0.1, 100], v: [1, 50] },
        symbolic: "p = m v" // 
    },

    // --- WAVES ---
    {
        name: "Wave Speed",
        vars: { v: "wave speed", f: "frequency", L: "wavelength" },
        units: { v: "m/s", f: "Hz", L: "m" },
        formula: (v) => v.f * v.L,
        solveFor: {
            v: { calc: (v) => v.f * v.L, sym: "v = f &times; &lambda;" },
            f: { calc: (v) => v.v / v.L, sym: "f = v / &lambda;" },
            L: { calc: (v) => v.v / v.f, sym: "&lambda; = v / f" }
        },
        ranges: { v: [330, 300000000], f: [1, 1000000], L: [0.001, 100] },
        symbolic: "v = f &lambda;" // 
    },
    {
        name: "Magnification",
        vars: { M: "magnification", i: "image height", o: "object height" },
        units: { M: "none", i: "cm", o: "cm" },
        formula: (v) => v.i / v.o,
        solveFor: {
            M: { calc: (v) => v.i / v.o, sym: "Magnification = image height / object height" },
            i: { calc: (v) => v.M * v.o, sym: "image height = Magnification &times; object height" },
            o: { calc: (v) => v.i / v.M, sym: "object height = image height / Magnification" }
        },
        ranges: { M: [0.1, 10], i: [1, 50], o: [1, 50] },
        symbolic: "Magnification = image height / object height" // 
    }
    
    // --- THERMAL ENERGY ---
    {
        name: "Change in Thermal Energy",
        vars: { dE: "change in thermal energy", m: "mass", c: "specific heat capacity", dTheta: "temperature change" },
        units: { dE: "J", m: "kg", c: "J/kg°C", dTheta: "°C" },
        formula: (v) => v.m * v.c * v.dTheta,
        solveFor: {
            dE: { calc: (v) => v.m * v.c * v.dTheta, sym: "ΔE = m &times; c &times; Δθ" },
            m: { calc: (v) => v.dE / (v.c * v.dTheta), sym: "m = ΔE / (c &times; Δθ)" },
            c: { calc: (v) => v.dE / (v.m * v.dTheta), sym: "c = ΔE / (m &times; Δθ)" },
            dTheta: { calc: (v) => v.dE / (v.m * v.c), sym: "Δθ = ΔE / (m &times; c)" }
        },
        ranges: { dE: [100, 50000], m: [0.1, 5], c: [400, 4200], dTheta: [1, 80] },
        symbolic: "ΔE = m c Δθ" // 
    },
    {
        name: "Specific Latent Heat",
        vars: { E: "thermal energy for change of state", m: "mass", L: "specific latent heat" },
        units: { E: "J", m: "kg", L: "J/kg" },
        formula: (v) => v.m * v.L,
        solveFor: {
            E: { calc: (v) => v.m * v.L, sym: "E = m &times; L" },
            m: { calc: (v) => v.E / v.L, sym: "m = E / L" },
            L: { calc: (v) => v.E / v.m, sym: "L = E / m" }
        },
        ranges: { E: [1000, 100000], m: [0.01, 2], L: [334000, 2260000] },
        symbolic: "E = m L" // 
    },

    // --- GASES & PRESSURE ---
    {
        name: "Gases: Pressure/Volume Constant",
        vars: { p: "pressure", V: "volume", k: "constant" },
        units: { p: "Pa", V: "m&sup3;", k: "none" },
        formula: (v) => v.p * v.V,
        solveFor: {
            p: { calc: (v) => v.k / v.V, sym: "p = constant / V" },
            V: { calc: (v) => v.k / v.p, sym: "V = constant / p" },
            k: { calc: (v) => v.p * v.V, sym: "p &times; V = constant" }
        },
        ranges: { p: [10000, 101325], V: [0.01, 5], k: [100, 500] },
        symbolic: "p V = constant" // 
    },
    {
        name: "Pressure on a Surface",
        vars: { p: "pressure", F: "force normal to surface", A: "area" },
        units: { p: "Pa", F: "N", A: "m&sup2;" },
        formula: (v) => v.F / v.A,
        solveFor: {
            p: { calc: (v) => v.F / v.A, sym: "p = F / A" },
            F: { calc: (v) => v.p * v.A, sym: "F = p &times; A" },
            A: { calc: (v) => v.F / v.p, sym: "A = F / p" }
        },
        ranges: { p: [1, 10000], F: [1, 500], A: [0.01, 10] },
        symbolic: "p = F / A" // 
    },
    {
        name: "Pressure in a Liquid (HT)",
        vars: { p: "pressure", h: "height of column", rho: "density of liquid", g: "gravitational field strength" },
        units: { p: "Pa", h: "m", rho: "kg/m&sup3;", g: "N/kg" },
        formula: (v) => v.h * v.rho * v.g,
        solveFor: {
            p: { calc: (v) => v.h * v.rho * v.g, sym: "p = h &times; &rho; &times; g" },
            h: { calc: (v) => v.p / (v.rho * v.g), sym: "h = p / (&rho; &times; g)" },
            rho: { calc: (v) => v.p / (v.h * v.g), sym: "&rho; = p / (h &times; g)" },
            g: { calc: (v) => v.p / (v.h * v.rho), sym: "g = p / (h &times; &rho;)" }
        },
        ranges: { p: [100, 10000], h: [0.5, 20], rho: [800, 1000], g: [9.8, 10] },
        symbolic: "p = h &rho; g" // 
    },

    // --- MOTION & FORCES ---
    {
        name: "Acceleration",
        vars: { a: "acceleration", dv: "change in velocity", t: "time taken" },
        units: { a: "m/s&sup2;", dv: "m/s", t: "s" },
        formula: (v) => v.dv / v.t,
        solveFor: {
            a: { calc: (v) => v.dv / v.t, sym: "a = Δv / t" },
            dv: { calc: (v) => v.a * v.t, sym: "Δv = a &times; t" },
            t: { calc: (v) => v.dv / v.a, sym: "t = Δv / a" }
        },
        ranges: { a: [0.1, 10], dv: [1, 50], t: [1, 30] },
        symbolic: "a = Δv / t" // 
    },
    {
        name: "Uniform Acceleration",
        vars: { v2: "final velocity squared", u2: "initial velocity squared", a: "acceleration", s: "distance" },
        units: { v2: "m&sup2;/s&sup2;", u2: "m&sup2;/s&sup2;", a: "m/s&sup2;", s: "m" },
        formula: (v) => v.u2 + (2 * v.a * v.s),
        solveFor: {
            v2: { calc: (v) => v.u2 + (2 * v.a * v.s), sym: "v&sup2; = u&sup2; + 2as" },
            u2: { calc: (v) => v.v2 - (2 * v.a * v.s), sym: "u&sup2; = v&sup2; - 2as" },
            a: { calc: (v) => (v.v2 - v.u2) / (2 * v.s), sym: "a = (v&sup2; - u&sup2;) / 2s" },
            s: { calc: (v) => (v.v2 - v.u2) / (2 * v.a), sym: "s = (v&sup2; - u&sup2;) / 2a" }
        },
        ranges: { v2: [100, 400], u2: [0, 100], a: [1, 10], s: [1, 50] },
        symbolic: "v&sup2; - u&sup2; = 2 a s" // 
    },
    {
        name: "Force on Momentum (HT)",
        vars: { F: "force", mdv: "change in momentum", t: "time" },
        units: { F: "N", mdv: "kg m/s", t: "s" },
        formula: (v) => v.mdv / v.t,
        solveFor: {
            F: { calc: (v) => v.mdv / v.t, sym: "F = mΔv / Δt" },
            mdv: { calc: (v) => v.F * v.t, sym: "mΔv = F &times; Δt" },
            t: { calc: (v) => v.mdv / v.F, sym: "Δt = mΔv / F" }
        },
        ranges: { F: [1, 500], mdv: [10, 1000], t: [0.1, 5] },
        symbolic: "F = mΔv / Δt" // 
    },

    // --- ELECTROMAGNETISM ---
    {
        name: "Force on a Conductor (HT)",
        vars: { F: "force", B: "magnetic flux density", I: "current", L: "length" },
        units: { F: "N", B: "T", I: "A", L: "m" },
        formula: (v) => v.B * v.I * v.L,
        solveFor: {
            F: { calc: (v) => v.B * v.I * v.L, sym: "F = B &times; I &times; l" },
            B: { calc: (v) => v.F / (v.I * v.L), sym: "B = F / (I &times; l)" },
            I: { calc: (v) => v.F / (v.B * v.L), sym: "I = F / (B &times; l)" },
            L: { calc: (v) => v.F / (v.B * v.I), sym: "l = F / (B &times; I)" }
        },
        ranges: { F: [0.01, 10], B: [0.01, 2], I: [0.1, 10], L: [0.05, 2] },
        symbolic: "F = B I l" // 
    },
    {
        name: "Transformer Efficiency (HT)",
        vars: { Vp: "PD primary", Ip: "current primary", Vs: "PD secondary", Is: "current secondary" },
        units: { Vp: "V", Ip: "A", Vs: "V", Is: "A" },
        formula: (v) => v.Vs * v.Is, // Power check
        solveFor: {
            Vp: { calc: (v) => (v.Vs * v.Is) / v.Ip, sym: "V<sub>p</sub> = (V<sub>s</sub> &times; I<sub>s</sub>) / I<sub>p</sub>" },
            Ip: { calc: (v) => (v.Vs * v.Is) / v.Vp, sym: "I<sub>p</sub> = (V<sub>s</sub> &times; I<sub>s</sub>) / V<sub>p</sub>" },
            Vs: { calc: (v) => (v.Vp * v.Ip) / v.Is, sym: "V<sub>s</sub> = (V<sub>p</sub> &times; I<sub>p</sub>) / I<sub>s</sub>" },
            Is: { calc: (v) => (v.Vp * v.Ip) / v.Vs, sym: "I<sub>s</sub> = (V<sub>p</sub> &times; I<sub>p</sub>) / V<sub>s</sub>" }
        },
        ranges: { Vp: [100, 240], Ip: [0.1, 5], Vs: [5, 50], Is: [1, 20] },
        symbolic: "V<sub>p</sub> I<sub>p</sub> = V<sub>s</sub> I<sub>s</sub>" // 
    },
    {
        name: "Power (Work)",
        vars: { P: "power", W: "work done", t: "time" },
        units: { P: "W", W: "J", t: "s" },
        formula: (v) => v.W / v.t,
        solveFor: {
            P: { calc: (v) => v.W / v.t, sym: "P = W / t" },
            W: { calc: (v) => v.P * v.t, sym: "W = P &times; t" },
            t: { calc: (v) => v.W / v.P, sym: "t = W / P" }
        },
        ranges: { P: [10, 2000], W: [100, 10000], t: [1, 60] },
        symbolic: "P = W / t"
    },
    {
        name: "Efficiency",
        vars: { e: "efficiency", out: "useful output energy", in: "total input energy" },
        units: { e: "none", out: "J", in: "J" },
        formula: (v) => v.out / v.in,
        solveFor: {
            e: { calc: (v) => v.out / v.in, sym: "Efficiency = Useful Out / Total In" },
            out: { calc: (v) => v.e * v.in, sym: "Useful Out = Efficiency &times; Total In" },
            in: { calc: (v) => v.out / v.e, sym: "Total In = Useful Out / Efficiency" }
        },
        ranges: { e: [0.1, 0.95], out: [10, 400], in: [500, 1000] },
        symbolic: "Efficiency = Useful Out / Total In"
    },
    {
        name: "Power (Current and Resistance)",
        vars: { P: "power", I: "current", R: "resistance" },
        units: { P: "W", I: "A", R: "&Omega;" },
        formula: (v) => Math.pow(v.I, 2) * v.R,
        solveFor: {
            P: { calc: (v) => Math.pow(v.I, 2) * v.R, sym: "P = I&sup2; &times; R" },
            I: { calc: (v) => Math.sqrt(v.P / v.R), sym: "I = &radic;(P / R)" },
            R: { calc: (v) => v.P / Math.pow(v.I, 2), sym: "R = P / I&sup2;" }
        },
        ranges: { P: [1, 2000], I: [0.1, 13], R: [1, 500] },
        symbolic: "P = I&sup2; R" // 
    },
    {
        name: "Energy Transferred (Charge)",
        vars: { E: "energy transferred", Q: "charge flow", V: "potential difference" },
        units: { E: "J", Q: "C", V: "V" },
        formula: (v) => v.Q * v.V,
        solveFor: {
            E: { calc: (v) => v.Q * v.V, sym: "E = Q &times; V" },
            Q: { calc: (v) => v.E / v.V, sym: "Q = E / V" },
            V: { calc: (v) => v.E / v.Q, sym: "V = E / Q" }
        },
        ranges: { E: [1, 5000], Q: [1, 100], V: [1, 230] },
        symbolic: "E = Q V" // [cite: 31, 33]
    },
    {
        name: "Force (Spring Constant)",
        vars: { F: "force", k: "spring constant", e: "extension" },
        units: { F: "N", k: "N/m", e: "m" },
        formula: (v) => v.k * v.e,
        solveFor: {
            F: { calc: (v) => v.k * v.e, sym: "F = k &times; e" },
            k: { calc: (v) => v.F / v.e, sym: "k = F / e" },
            e: { calc: (v) => v.F / v.k, sym: "e = F / k" }
        },
        ranges: { F: [1, 100], k: [1, 500], e: [0.01, 2] },
        symbolic: "F = k e" // 
    },
    {
        name: "Distance Travelled",
        vars: { s: "distance travelled", v: "speed", t: "time" },
        units: { s: "m", v: "m/s", t: "s" },
        formula: (v) => v.v * v.t,
        solveFor: {
            s: { calc: (v) => v.v * v.t, sym: "s = v &times; t" },
            v: { calc: (v) => v.s / v.t, sym: "v = s / t" },
            t: { calc: (v) => v.s / v.v, sym: "t = s / v" }
        },
        ranges: { s: [1, 5000], v: [1, 40], t: [1, 300] },
        symbolic: "s = v t" // 
    },
    {
        name: "Newton's Second Law",
        vars: { F: "resultant force", m: "mass", a: "acceleration" },
        units: { F: "N", m: "kg", a: "m/s&sup2;" },
        formula: (v) => v.m * v.a,
        solveFor: {
            F: { calc: (v) => v.m * v.a, sym: "F = m &times; a" },
            m: { calc: (v) => v.F / v.a, sym: "m = F / a" },
            a: { calc: (v) => v.F / v.m, sym: "a = F / m" }
        },
        ranges: { F: [1, 1000], m: [0.1, 100], a: [0.1, 20] },
        symbolic: "F = m a" // 
    },
    {
        name: "Period of a Wave",
        vars: { T: "period", f: "frequency" },
        units: { T: "s", f: "Hz" },
        formula: (v) => 1 / v.f,
        solveFor: {
            T: { calc: (v) => 1 / v.f, sym: "T = 1 / f" },
            f: { calc: (v) => 1 / v.T, sym: "f = 1 / T" }
        },
        ranges: { T: [0.001, 10], f: [0.1, 1000] },
        symbolic: "T = 1 / f" // 
    },
    {
        name: "Transformer Equation (HT)",
        vars: { Vp: "PD across primary", Vs: "PD across secondary", np: "turns on primary", ns: "turns on secondary" },
        units: { Vp: "V", Vs: "V", np: "turns", ns: "turns" },
        formula: (v) => (v.Vp / v.Vs), // Ratio check
        solveFor: {
            Vp: { calc: (v) => (v.Vs * v.np) / v.ns, sym: "V<sub>p</sub> = (V<sub>s</sub> &times; n<sub>p</sub>) / n<sub>s</sub>" },
            Vs: { calc: (v) => (v.Vp * v.ns) / v.np, sym: "V<sub>s</sub> = (V<sub>p</sub> &times; n<sub>s</sub>) / n<sub>p</sub>" },
            np: { calc: (v) => (v.Vp * v.ns) / v.Vs, sym: "n<sub>p</sub> = (V<sub>p</sub> &times; n<sub>s</sub>) / v<sub>s</sub>" },
            ns: { calc: (v) => (v.Vs * v.np) / v.Vp, sym: "n<sub>s</sub> = (V<sub>s</sub> &times; n<sub>p</sub>) / V<sub>p</sub>" }
        },
        ranges: { Vp: [100, 240], Vs: [5, 50], np: [200, 1000], ns: [10, 100] },
        symbolic: "V<sub>p</sub> / V<sub>s</sub> = n<sub>p</sub> / n<sub>s</sub>" // 
    }
];

const unitPool = ["N", "kg", "N/kg", "J", "m", "W", "s", "m/s", "m/s&sup2;", "none", "A", "V", "&Omega;", "C", "T", "m&sup2;"];

class PhysicsQuiz {
    constructor() {
        this.currentQuestion = null;
        this.attempts = 4;
        this.score = 0;
        this.attempted = 0;
        this.startTime = null;
        this.timerInterval = null;
        this.failedList = [];
    }

    formatNumber(n) {
        if (n >= 1000000 || n <= 0.0001) {
            let str = n.toExponential(2);
            return str.replace(/e\+?/, " x10<sup>") + "</sup>";
        }
        return parseFloat(n.toPrecision(3)).toString();
    }

    start() {
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('quiz-ui').style.display = 'block';
        this.startTime = Date.now();
        this.timerInterval = setInterval(() => this.updateTimer(), 1000);
        this.nextQuestion();
    }

    updateTimer() {
        const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
        const m = String(Math.floor(elapsed / 60)).padStart(2, '0');
        const s = String(elapsed % 60).padStart(2, '0');
        document.getElementById('timer').innerText = `${m}:${s}`;
    }

    nextQuestion() {
        if (this.attempted >= 15) return this.finish();
        
        this.attempts = 4;
        const eq = equations[Math.floor(Math.random() * equations.length)];
        const targetVar = Object.keys(eq.vars)[Math.floor(Math.random() * Object.keys(eq.vars).length)];
        
        let vals = {};
        Object.keys(eq.vars).forEach(v => {
            const range = eq.ranges[v];
            vals[v] = Math.random() * (range[1] - range[0]) + range[0];
        });

        // Specific Logic Checks
        if(eq.name === "Efficiency") {
            vals.in = Math.max(vals.in, vals.out * 1.5);
            vals.e = vals.out / vals.in;
        }

        vals[targetVar] = eq.solveFor[targetVar].calc(vals);
        this.currentQuestion = { eq, targetVar, vals, answer: vals[targetVar] };
        this.render();
    }

    render() {
        const cq = this.currentQuestion;
        let qText = `A student needs to find the <b>${cq.eq.vars[cq.targetVar]}</b>. <br>Given: `;
        const others = Object.keys(cq.eq.vars).filter(v => v !== cq.targetVar);
        const detail = others.map(v => `${cq.eq.vars[v]} = ${this.formatNumber(cq.vals[v])}&nbsp;${cq.eq.units[v]}`);
        
        document.getElementById('question-text').innerHTML = qText + detail.join(' and ') + ".";
        document.getElementById('progress').innerText = `${this.attempted}/15`;
        document.getElementById('attempts-left').innerText = `Attempts remaining: ${this.attempts}`;
        document.getElementById('feedback').innerText = "";
        ['hint-1', 'hint-2', 'hint-3'].forEach(h => document.getElementById(h).innerHTML = "");
        document.getElementById('user-answer').value = "";
        this.setupUnits();
    }

    setupUnits() {
        const correct = this.currentQuestion.eq.units[this.currentQuestion.targetVar];
        let options = [correct];
        while(options.length < 4) {
            let u = unitPool[Math.floor(Math.random() * unitPool.length)];
            if(!options.includes(u)) options.push(u);
        }
        options.sort(() => Math.random() - 0.5);
        document.getElementById('user-unit').innerHTML = options.map(u => `<option value="${u}">${u}</option>`).join('');
    }

    checkAnswer() {
        const uVal = parseFloat(document.getElementById('user-answer').value);
        const uUnit = document.getElementById('user-unit').value;
        const cVal = this.currentQuestion.answer;
        const cUnit = this.currentQuestion.eq.units[this.currentQuestion.targetVar];

        if (isNaN(uVal)) return;

        const isNumRight = Math.abs((uVal - cVal) / cVal) < 0.025;
        const isUnitRight = uUnit === cUnit;
        
        if (isNumRight && isUnitRight) {
            this.score++;
            this.attempted++;
            document.getElementById('score').innerText = this.score;
            document.getElementById('feedback').style.color = "#00ff88";
            document.getElementById('feedback').innerText = "Correct!";
            setTimeout(() => this.nextQuestion(), 1200);
        } else {
            this.attempts--;
            this.showFeedback(uVal, cVal, isNumRight, isUnitRight);
            if (this.attempts === 0) {
                this.failedList.push(this.currentQuestion.eq.name);
                this.attempted++;
                document.getElementById('hint-3').innerHTML = `Final Answer: ${this.formatNumber(cVal)} ${cUnit}`;
                setTimeout(() => this.nextQuestion(), 3000);
            }
        }
    }

    showFeedback(uVal, cVal, isNumRight, isUnitRight) {
        let msg = "Incorrect.";
        const logRatio = Math.log10(Math.abs(uVal / cVal));
        const isPowerOfTen = !isNumRight && Math.abs(logRatio - Math.round(logRatio)) < 0.01;

        if (isNumRight && !isUnitRight) msg = "Value correct, but wrong unit!";
        else if (isPowerOfTen) msg = "Check your powers of ten!";

        document.getElementById('feedback').style.color = "#ffcf00";
        document.getElementById('feedback').innerText = msg;
        document.getElementById('attempts-left').innerText = `Attempts remaining: ${this.attempts}`;

        if (this.attempts <= 2) {
            document.getElementById('hint-1').innerHTML = `&bull; Equation: ${this.currentQuestion.eq.symbolic}`;
        }
        if (this.attempts <= 1) {
            document.getElementById('hint-2').innerHTML = `&bull; Rearrangement: ${this.currentQuestion.eq.solveFor[this.currentQuestion.targetVar].sym}`;
        }
    }

    skipQuestion() {
        this.failedList.push(this.currentQuestion.eq.name + " (Skipped)");
        this.attempted++;
        this.nextQuestion();
    }

    finish() {
        clearInterval(this.timerInterval);
        document.getElementById('quiz-ui').style.display = 'none';
        document.getElementById('result-screen').style.display = 'block';
        document.getElementById('final-stats').innerHTML = `${this.score} / 15<br><span style="font-size:1rem">Time: ${document.getElementById('timer').innerText}</span>`;
        
        const list = [...new Set(this.failedList)];
        document.getElementById('review-list').innerHTML = list.length ? 
            "<strong>Equations to review:</strong><ul>" + list.map(l => `<li>${l}</li>`).join('') + "</ul>" : "Perfect Score!";
    }
}

const quiz = new PhysicsQuiz();
</script>
